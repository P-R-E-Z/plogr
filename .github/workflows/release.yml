name: Release RPM

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  build-and-sign:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            /root/.cache/pip
            /root/.cache/uv
          key: ${{ runner.os }}-release-${{ hashFiles('pyproject.toml', 'uv.lock') }}

      - name: Install build tools
        run: |
          dnf -y install rpm-build rpmlint gnupg copr-cli git-core python3-pip
          dnf -y install cmake gcc-c++ libdnf5-devel pkgconfig clang-tools-extra
          pip install build ruff black mypy
          # Ensure we build with a supported interpreter (3.12/3.13); avoid 3.14 until PyO3 supports it.
          ln -sf /usr/bin/python3.13 /usr/local/bin/python || true

      - name: Install project dependencies
        run: |
          UV_PYTHON=python3.13 PYO3_PYTHON=python3.13 pip install -e .

      - name: Run linting checks
        run: |
          ruff check src/
          black --check src/
          mypy src/

      - name: Check C++ formatting
        run: |
          clang-format --dry-run --Werror libdnf5-plugin/dnf5-plugin/src/*.cpp || exit 1

      - name: Run tests
        run: |
          pip install pytest pytest-cov
          pytest -q

      - name: Import GPG key (for rpmsign)
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY not set; failing release because signing is required."
            exit 1
          fi
          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import -
          echo "%_gpg_name Prez" >> ~/.rpmmacros
          printf "%%_signature gpg\n%%_gpg_path ~/.gnupg\n%%_gpgbin $(which gpg)\n%%_gpg_passphrase $GPG_PASSPHRASE\n" >> ~/.rpmmacros

      - name: Build source distribution
        run: |
          UV_PYTHON=python3.13 PYO3_PYTHON=python3.13 python3 -m build --sdist
          rpmlint -v plogr.spec || true

      - name: Build C++ plugin
        run: |
          cd libdnf5-plugin/dnf5-plugin
          cmake -B build
          cmake --build build

      - name: Create dist directory
        run: mkdir -p dist

      - name: Build SRPM and RPM
        run: |
          rpmbuild -bs plogr.spec --define "_sourcedir $(pwd)" --define "_srcrpmdir $(pwd)/dist"
          rpmbuild -bb plogr.spec --define "_sourcedir $(pwd)" --define "_rpmdir $(pwd)/dist" --define "_srcrpmdir $(pwd)/dist"

      - name: Run rpmlint on built RPMs
        run: |
          if ls dist/*.rpm 1> /dev/null 2>&1; then
            rpmlint dist/*.rpm || true
          else
            echo "No RPM files found in dist directory"
            exit 1
          fi

      - name: Upload build artifacts (SRPM/RPM)
        uses: actions/upload-artifact@v4
        with:
          name: plogr-dist
          path: dist/*

      - name: Sign RPMs
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          rpms=(dist/*.rpm)
          if [ ${#rpms[@]} -eq 0 ]; then
            echo "No RPM files to sign"
            exit 1
          fi
          for rpm in "${rpms[@]}"; do
            rpmsign --addsign "$rpm"
          done

      - name: Upload to Copr
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        shell: bash
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "COPR credentials not set; failing release because upload is required."
            exit 1
          fi
          for srpm in dist/*.src.rpm; do
            copr-cli build "$COPR_LOGIN/plogr" "$srpm"
          done

      - name: Publish GitHub Release with assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: plogr ${{ github.ref_name }}
          files: |
            dist/*.rpm
            dist/*.src.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}